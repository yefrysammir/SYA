<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>Lock Numérico</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Fuentes / Iconos -->
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300" rel="stylesheet"/>

<style>
:root { --primary:#ffa0e5; --text:#fff; --glass:rgba(0,0,0,.4); }

/* Global */
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none;}
html,body{width:100%;height:100dvh;min-height:100vh;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--text);overflow:hidden;background:#000;-webkit-text-size-adjust:100%;}

/* Lock Screen */
#lockScreen{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:url("momentos/foto0.jpg") no-repeat center/cover;transition:transform .7s ease-in-out;z-index:10;}
#lockScreen::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.35);pointer-events:none;}
.lockContent{position:relative;display:flex;flex-direction:column;align-items:center;z-index:1;width:100%;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);}
.heart{font-size:3rem;margin-bottom:1rem;animation:heartbeat 1.8s infinite;}
@keyframes heartbeat{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
#pinDots{display:flex;gap:.5rem;margin-bottom:1rem;}
.dot{width:.9rem;height:.9rem;border-radius:50%;border:2px solid var(--text);background:transparent;transition:.2s;}
.dot.filled{background:var(--text);}
#message{font-size:1.1rem;margin-bottom:1rem;min-height:1.5rem;opacity:0;transition:opacity .3s ease;}
#message.show{opacity:1;}
.shake{animation:shake .4s;}
@keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-8px);}40%,80%{transform:translateX(8px);}}

/* Keypad */
#keypad{display:grid;grid-template-columns:repeat(3,min(20vw,70px));gap:1rem;justify-content:center;}
.key{width:min(20vw,70px);height:min(20vw,70px);border-radius:50%;background:var(--glass);color:var(--text);display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;backdrop-filter:blur(6px);transition:.18s;position:relative;overflow:hidden;touch-action:manipulation;}
.key.active{transform:scale(0.9);}
.key::after{content:"";position:absolute;width:120%;height:120%;top:50%;left:50%;background:rgba(255,255,255,.2);border-radius:50%;transform:translate(-50%,-50%) scale(0);transition:transform .3s,opacity .3s;opacity:0;}
.key.active::after{transform:translate(-50%,-50%) scale(1);opacity:1;}
.material-symbols-outlined{font-size:2rem;}

/* Topbar Stories */
#topbar{position:fixed;top:env(safe-area-inset-top,0);left:0;right:0;z-index:6;display:none;justify-content:center;padding:.5rem 1rem;}
.searchWrap{flex:1;max-width:700px;display:flex;align-items:center;gap:.5rem;background:var(--glass);backdrop-filter:blur(6px);border-radius:999px;padding:.35rem .75rem;}
.searchWrap .icon{font-size:1.4rem;opacity:.9;}
#slideSearch{flex:1;border:none;outline:none;background:transparent;color:var(--text);font-size:1rem;padding:.35rem 0;}
#slideSearch::placeholder{color:#ddd;opacity:.7;}
.counter{font-variant-numeric:tabular-nums;opacity:.9;white-space:nowrap;}

/* Stories (slider JS) */
#stories{position:fixed;inset:0;background:#000;overflow:hidden;transform:translateY(100%);transition:transform .7s ease-in-out;z-index:5;}
#track{width:100%;height:100%;will-change:transform;touch-action:none;} /* touch-action se setea también por JS */
.story{height:100dvh;width:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;position:relative;padding:2rem;background-size:cover;background-position:center;}
.story::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.4);}
.storyContent{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:0 1rem;}
.story h2{font-family:"Dancing Script",cursive;font-size:2rem;margin-bottom:.5rem;}
.story .date{font-size:1rem;opacity:.85;margin-bottom:1rem;}
.story p{font-size:1.1rem;line-height:1.4;}
@media (min-width:768px){.story h2{font-size:2.4rem}.story p{font-size:1.2rem}}
</style>
</head>
<body oncontextmenu="return false;">

<!-- Lock -->
<div id="lockScreen">
  <div class="lockContent">
    <span class="material-symbols-outlined heart">favorite</span>
    <div id="message" class="show">Ingrese código</div>
    <div id="pinDots"></div>
    <div id="keypad"></div>
  </div>
</div>

<!-- Topbar -->
<div id="topbar">
  <div class="searchWrap">
    <span class="material-symbols-outlined icon">search</span>
    <input id="slideSearch" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Ir a slide # (1…N)"/>
    <div class="counter"><span id="currentIdx">1</span> / <span id="totalIdx">1</span></div>
  </div>
</div>

<!-- Stories (JS slider) -->
<div id="stories" aria-label="Historias de pareja">
  <div id="track"></div>
</div>

<script>
/* ==================== Config ==================== */
const PASSWORD_HASH="4908ef154f13f297da224aceaa78fbbedfc12adf625611d8972b148c43c9e46d";
const PIN_LENGTH=6;

/* ==================== State / Elements ==================== */
const dots=document.getElementById("pinDots");
const msg=document.getElementById("message");
const keypad=document.getElementById("keypad");
const lockScreen=document.getElementById("lockScreen");
const stories=document.getElementById("stories");
const track=document.getElementById("track");
const topbar=document.getElementById("topbar");
const slideSearch=document.getElementById("slideSearch");
const currentIdxEl=document.getElementById("currentIdx");
const totalIdxEl=document.getElementById("totalIdx");

/* ==================== PIN dots ==================== */
const dotEls=[];
for(let i=0;i<PIN_LENGTH;i++){const d=document.createElement("div");d.className="dot";dots.appendChild(d);dotEls.push(d);}

/* ==================== Keypad (pointer events) ==================== */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function attachKey(el, onPress){
  const down=e=>{e.preventDefault();el.classList.add("active");onPress();};
  const up=()=>el.classList.remove("active");
  el.addEventListener("pointerdown",down,{passive:false});
  el.addEventListener("pointerup",up); el.addEventListener("pointercancel",up); el.addEventListener("pointerleave",up);
}
function renderKeypad(){
  keypad.innerHTML="";
  shuffle([...Array(10).keys()]).forEach(n=>{
    const k=document.createElement("div");k.className="key";k.textContent=n;attachKey(k,()=>enterDigit(n));keypad.appendChild(k);
  });
  const del=document.createElement("div");del.className="key material-symbols-outlined";del.textContent="backspace";del.title="Borrar";
  attachKey(del,deleteDigit);keypad.appendChild(del);
}
renderKeypad();

/* ==================== PIN logic ==================== */
let input="";
async function hashPassword(pwd){const enc=new TextEncoder().encode(pwd);const buf=await crypto.subtle.digest("SHA-256",enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");}
function enterDigit(n){if(input.length>=PIN_LENGTH)return;input+=String(n);dotEls[input.length-1].classList.add("filled");if(input.length===PIN_LENGTH)checkPassword();}
function deleteDigit(){if(input.length>0){dotEls[input.length-1].classList.remove("filled");input=input.slice(0,-1);}}
function showMessage(text,shake=false){msg.classList.remove("show");setTimeout(()=>{msg.textContent=text;msg.classList.add("show");if(shake){msg.classList.add("shake");setTimeout(()=>msg.classList.remove("shake"),400)}},150);}
async function checkPassword(){
  const hash=await hashPassword(input);
  if(hash===PASSWORD_HASH){
    showMessage("✔ Desbloqueado!");
    lockScreen.style.transform="translateY(-100%)";
    stories.style.transform="translateY(0)";
    topbar.style.display="flex";
    initStories(); // carga JSON + slider
  }else{
    input="";dotEls.forEach(d=>d.classList.remove("filled"));renderKeypad();showMessage("Código incorrecto",true);
  }
}

/* ==================== Stories (slider JS con loop infinito) ==================== */
let recuerdos=[];        // JSON cargado
let N=0;                 // total original
let pageH=0;             // altura de página
let pos=1;               // índice en DOM con clones (0..N+1) — empezamos en 1 (1er real)
let dragging=false, animating=false, startY=0, baseY=0, rafId=0, latestDelta=0;

// Crea nodo story
function crearStory(item, originalIndex){
  const sec=document.createElement("section");
  sec.className="story";
  sec.style.backgroundImage=`url('${item.fondo}')`;
  sec.dataset.original = String(originalIndex); // 0..N-1
  sec.innerHTML=`
    <div class="storyContent">
      <h2>${item.titulo}</h2>
      <div class="date">${formateaFechaES(item.fecha)}</div>
      <p>${item.descripcion}</p>
    </div>`;
  return sec;
}
function formateaFechaES(iso){
  try{const d=new Date(iso+"T12:00:00");const meses=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];return `${d.getDate()} de ${meses[d.getMonth()]} del ${d.getFullYear()}`;}catch(e){return iso;}
}

// Preload para evitar parpadeos
function preloadFondos(arr){arr.forEach(x=>{const img=new Image();img.src=x.fondo;});}

// Construye DOM con clones (last al inicio, first al final)
function buildTrack(){
  track.innerHTML="";
  if(!N) return;
  // clone last
  track.appendChild(crearStory(recuerdos[N-1], N-1));
  // reales
  recuerdos.forEach((it,idx)=>track.appendChild(crearStory(it, idx)));
  // clone first
  track.appendChild(crearStory(recuerdos[0], 0));
}

// Medidas y posicion inicial
function measure(){
  pageH = stories.clientHeight || window.innerHeight;
}
function setTransform(y, withTransition=false){
  if(withTransition){track.style.transition="transform 350ms ease";} else {track.style.transition="none";}
  track.style.transform=`translate3d(0, ${y}px, 0)`;
}
function updateCounterFromPos(){
  const realIdx = (pos-1+N)%N; // 0..N-1
  currentIdxEl.textContent = String(realIdx+1);
}
function goToPos(p, animate=true){
  pos=p;
  const y = -pos * pageH;
  setTransform(y, animate);
  updateCounterFromPos();
}
// Re-ubicar si caímos en clone
function normalizeIfClone(){
  if(pos===0){ // estábamos en clone last (arriba)
    pos=N; setTransform(-pos*pageH,false); // salto instantáneo sin transición
  }else if(pos===N+1){ // clone first (abajo)
    pos=1; setTransform(-pos*pageH,false);
  }
  updateCounterFromPos();
}

// Gestos (drag)
function onPointerDown(e){
  if(animating) return;
  dragging=true; startY=e.clientY; baseY = -pos*pageH; latestDelta=0;
  track.setPointerCapture(e.pointerId);
  // forzamos sin transición al arrastrar
  setTransform(baseY,false);
  // rAF loop para aplicar delta suave
  const loop=()=>{ if(!dragging){cancelAnimationFrame(rafId); return;} setTransform(baseY + latestDelta, false); rafId=requestAnimationFrame(loop); };
  rafId=requestAnimationFrame(loop);
}
function onPointerMove(e){
  if(!dragging) return;
  latestDelta = e.clientY - startY;
}
function onPointerUp(e){
  if(!dragging) return;
  dragging=false;
  const delta = e.clientY - startY;
  const threshold = pageH * 0.15; // 15% de la pantalla
  if(Math.abs(delta) > threshold){
    if(delta < 0) pos+=1; else pos-=1; // up -> siguiente, down -> anterior
  }
  animating=true;
  goToPos(pos, true);
  track.addEventListener("transitionend", onTransitionEnd, {once:true});
}
function onTransitionEnd(){
  animating=false;
  normalizeIfClone(); // corrige a bloque real si estábamos en clon
}

// Mouse wheel (desktop) con cooldown
let lastWheel=0;
function onWheel(e){
  const now=Date.now();
  if(animating || dragging || now-lastWheel<350) return;
  if(Math.abs(e.deltaY)<20) return;
  lastWheel=now;
  pos += (e.deltaY>0)?1:-1;
  animating=true;
  goToPos(pos, true);
  track.addEventListener("transitionend", onTransitionEnd, {once:true});
}

// Buscar por # (va al bloque central real)
function goToIndexReal(n){ // n: 1..N
  n = Math.max(1, Math.min(N, n|0));
  pos = n; // porque en nuestro track: [cloneLast]=0, reales 1..N, [cloneFirst]=N+1
  animating=true;
  goToPos(pos, true);
  track.addEventListener("transitionend", onTransitionEnd, {once:true});
}

/* === Init principal === */
async function initStories(){
  try{
    const res = await fetch("recuerdos.json",{cache:"no-store"});
    recuerdos = await res.json();
  }catch(err){
    console.error("No se pudo cargar recuerdos.json", err);
    recuerdos = []; // si falla, no construimos slider
  }
  if(!recuerdos.length){
    // fallback mínimo para que no quede vacío
    recuerdos = [{titulo:"Hola",fecha:"2025-08-21",descripcion:"Agrega recuerdos.json",fondo:"momentos/foto1.jpg"}];
  }
  N = recuerdos.length;
  totalIdxEl.textContent = String(N);
  preloadFondos(recuerdos);
  buildTrack();
  measure();
  pos = 1; // 1er real
  setTransform(-pos*pageH,false);
  updateCounterFromPos();

  // Eventos de interacción
  track.style.touchAction="none"; // por JS, no CSS
  track.addEventListener("pointerdown", onPointerDown);
  track.addEventListener("pointermove", onPointerMove);
  track.addEventListener("pointerup", onPointerUp);
  track.addEventListener("pointercancel", onPointerUp);
  stories.addEventListener("wheel", onWheel, {passive:true});

  // Buscador
  slideSearch.addEventListener("change", ()=>{
    const v=parseInt(slideSearch.value,10);
    if(!isNaN(v)) goToIndexReal(v);
  });
  slideSearch.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){
      const v=parseInt(slideSearch.value,10);
      if(!isNaN(v)) goToIndexReal(v);
    }
  });

  // Resize / rotación
  window.addEventListener("resize", ()=>{
    const realIdx = (pos-1+N)%N; // guarda slide real
    measure();
    pos = realIdx+1; // re-posicionar misma página real
    setTransform(-pos*pageH,false);
  });
}

/* ==================== Antizoom ==================== */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());
let lastTouchEnd=0;
document.addEventListener('touchend', e=>{const now=Date.now();if(now-lastTouchEnd<=300){e.preventDefault();}lastTouchEnd=now;},{passive:false});
document.addEventListener('wheel', e=>{if(e.ctrlKey){e.preventDefault();}}, {passive:false});

/* ==================== SW ==================== */
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js').catch(console.error);}
</script>
</body>
</html>